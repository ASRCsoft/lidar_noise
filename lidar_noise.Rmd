---
journal: jhm
layout: draft
title: Wind lidar signal reception as a hidden Markov process
author1: Andrew N. Other
author2: Fred T. Secondauthor
author3: Jeff Friedman
currentaddress: "Current address: Some other place, Germany"
affiliation: "American Meteorological Society,Boston, Massachusetts"
exauthors: 
  - name: William May
    exaffiliation: Atmospheric Sciences Research Center
    correspondingauthor: "American Meteorological Society, 45 Beacon St., Boston, MA 02108."
    email: \email{groupleader@unknown.uu}
  - name: Kara Sulia
    exaffiliation: Atmospheric Sciences Research Center
    currentaddress: "Current address: Some other place, Canada"
  - name: Jeff Friedman
    exaffiliation: Atmospheric Sciences Research Center
    currentaddress: "Current address: Some other place, Canada"
abstract: |
  Wind lidars are widely deployed to measure atmospheric wind speeds. However, wind speed measurements are corrupted by impulse noise when the lidar's laser backscatter is weaker than environmental background noise. We model lidar signal reception as a hidden Markov process that switches between a noise state and a signal state and draw on image processing research to obtain approximate solutions to the model. Using this model we are able to dramatically improve on the current data filtering methods in use for wind lidars.
bibliography: amstest.bib
output: rticles::ams_article
header-includes:
  - \usepackage{subfig}
---

```{r setup, echo=TRUE, include=FALSE}
if (file.exists('python_path.txt')) {
  python_path = readLines('python_path.txt')[1]
} else {
  python_path = Sys.which('python3')
}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, cache = TRUE,
                      engine.path = list(python = python_path))
knitr::knit_engines$set(python = reticulate::eng_python)
```

Python is at `r system('which python3', intern=T)`.

# Introduction

LIDAR, or light detection and ranging, technology uses span a myriad of scientific and intra-scientific disciplines, including, particularly within the earth sciences.  In atmospheric sciences alone, LIDAR is used to detect and measure a plethora of meteorological data, such as temperature, water vapor, boundary layer height, and aerosols \cite[e.g., ][, respectively]{Arshinov:1983,Ismail:1989,Menut:1999,Koch:2004}, among others. As a signal measuring instrument in which measurements are retrieved via backscatter, background noise accompanies data retrievals. As such, lidar instrumentation include noise-filtering software, typically designed by the lidar manufacturer. Such software include X (cite), Y (cite), and Z (cite) methodologies.

Of particular interest to this study is the Leosphere XXXX lidar used primarily to detect retrievals of wind, CNR, and Z. Moreover, the Leosphere lidar retrievals can be used to indirectly determine other atmospheric properties, such as, W, T, and U.  <more background on Leosphere lidar here>. The Leosphere lidar is used by the University at Albany Atmospheric Sciences Research Center as well as the New York State Mesonet, a new 126-site weather sensing network spanning New York State. Of the 126 sites, all of which include surface measuring instrumentation, 17 are collocated with profiling sites, at which the Leosphere lidar is among the instrumentation suite.

The Leosphere lidar currently has the XX noise-filtering algorithm built into the data-retrieval software. This methodology filters….<add here the current filtering thresholds>.  It is found that while this methodology serves to provide an acceptable range of retrieved data, the limitations of the aforementioned thresholds leave gaps in more precise retrievals of X, Y, and Z, and also leave behind (relatively obvious) noisy data among what is deemed real data. Hence, this work presented herein proposes a new technique for precise signal-noise discretization.


# Background

## Current filtering methods

Current classification strategies for lidar data typically involve a combination of signal strength thresholds and spike filters that leave some valid data incorrectly labeled as noise. Current filtering methods typically work in a two-step process: first a signal strength threshold is applied, which removes most contiguous sections of noise measurements where the signal is consistently low. The threshold is chosen to create a low type I error or false alarm rate. However lowering the false alarm rate implies increasing the type II error rate, so this step generally leaves some valid data incorrectly labeled as noise.

Due to the low false alarm rate most remaining data at this stage is valid. This creates an environment where a spike filter can be applied to remove the remaining extreme outliers. The spike filter can’t be usefully applied to the raw data without the signal threshold due to contiguous sections of noise.

A hidden markov vector autoregressive model that uses both the signal strength and data values simultaneously and incorporates spatial and temporal relationships to improve the measurement classification is proposed.


## Image Denoising

A wide variety of filters for predicting local pixel values are available in image processing research which we could potentially use to estimate local space/time error terms. We choose the median filter due to its robustness to “salt and pepper” noise. Salt and pepper noise in degraded images takes on extreme high (white salt) and low (black pepper) values. Typically the median filter is used to replace salt and pepper noise pixels with a more reasonable value derived from neighboring pixels. Given the extreme variance of radial wind speed noise measurements, methods designed for salt and pepper noise hold promise for dealing with lidar noise.


## Markov Random Fields

Because our data has both a space (Range) and time dimension, we model the data noise state as a markov random field, which is an n-dimensional generalization of a 1-dimensional markov chain. Markov random fields are commonly used in image processing to segment images, i.e. classify pixels.

For example, neuroimaging researchers use markov random fields to identify brain regions in MRI data, modeling each region as a distinct data generating process with values drawn from a Gaussian distribution. The markov random field incorporates spatial relationships between the voxels to produce more coherent classifications.

Existing methods from image segmentation research can estimate hidden markov random field models without autocorrelated error terms. However markov random field models with autocorrelated error terms are intractable. Therefore to estimate the model we have to remove the autocorrelated error terms.


## New York State Mesonet lidar network

The New York State Mesonet bought 17 lidars as part of a _____ grant. Before deployment at the chosen profiler locations, the lidars were tested on the roof of the CESTM building at the SUNY Polytechnic Institute. The lidars are usually run in DBS (Doppler Beam Swinging) mode, which records radial wind speeds from a vertical profile and 4 profiles 15 degrees off from vertical in each of the 4 cardinal directions. By combining radial wind speeds from different directions we are able to estimate the u, v, and w components of the wind speed.

The CESTM building also houses the National Weather Service, which releases radiosondes twice a day. 

# Methodology

The measurements are modeled as switching between noise and valid measurement states, which are described by distinct data generating processes. Due to local homogeneity of the atmosphere each measurement provides information about the state of neighboring measurements which we encode as a space- and time-switching markov random field. Local homogeneity of the atmosphere also creates a pattern of spatially and temporally autocorrelated error terms in the radial wind speed measurements.


```{python, fig.cap='Representative samples of data generated by wind and noise states', fig.align='center', fig.env="figure*"}
# add the current folder to the import path
import sys
sys.path.append('.')

# import modules
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
import math, warnings
import numpy as np
warnings.simplefilter("ignore")
import xarray as xr
from pandas.tseries import converter as pdtc
pdtc.register()

# read data
lidar = xr.open_dataset('cestm_roof80_20171003.nc')
lidar0 = lidar.sel(Time=lidar.coords['LOS'] == 0)

# get representative samples
lidar_good = lidar0.sel(Time=slice('2017-10-03T12:30', '2017-10-03T15:00'), Range=slice(200, 1000))
lidar_bad = lidar0.sel(Time=slice('2017-10-03T14:00', None), Range=slice(2200, 3000)).isel(Time=slice(0, lidar_good.dims['Time']))
# replace time coords
lidar_good.coords['Profile'] = ('Time', range(lidar_good.dims['Time']))
lidar_bad.coords['Profile'] = ('Time', range(lidar_good.dims['Time']))
lidar_good = lidar_good.swap_dims({'Time': 'Profile'})
lidar_bad = lidar_bad.swap_dims({'Time': 'Profile'})
# replace range coords
lidar_good.coords['Z'] = ('Range', range(lidar_good.dims['Range']))
lidar_bad.coords['Z'] = ('Range', range(lidar_good.dims['Range']))
lidar_good = lidar_good.swap_dims({'Range': 'Z'})
lidar_bad = lidar_bad.swap_dims({'Range': 'Z'})
# concatenate samples
lidar_good_samples = xr.concat([lidar_good['RWS'], lidar_good['CNR']], dim='Series')
lidar_bad_samples = xr.concat([lidar_bad['RWS'], lidar_bad['CNR']], dim='Series')
lidar_samples = xr.concat([lidar_good_samples, lidar_bad_samples], dim='State')
lidar_samples.coords['Series'] = ['RWS', 'CNR']
lidar_samples.coords['State'] = ['Wind', 'Noise']
lidar_samples

# rename some of the coordinates to make better graph labels
lidar_samples = lidar_samples.rename({'Time': 'Hour [UTC]', 'Range': 'Range [m]'})

# make figure
f, axarr = plt.subplots(2, 2)
xFmt = mdates.DateFormatter('%H')
for i, state in enumerate(['Wind', 'Noise']):
    # RWS
    lidar_samples.sel(Series='RWS', State=state).rename('RWS [m/s]').plot(x='Hour [UTC]', y='Range [m]', center=0, ax=axarr[0, i], rasterized=True)
    axarr[0, i].xaxis.set_major_locator(mdates.MinuteLocator(byminute=[0, 30]))
    axarr[0, i].xaxis.set_major_formatter(xFmt)
    # CNR
    lidar_samples.sel(Series='CNR', State=state).rename('CNR [dB]').plot(x='Hour [UTC]', y='Range [m]', ax=axarr[1, i], rasterized=True)
    axarr[1, i].xaxis.set_major_locator(mdates.MinuteLocator(byminute=[0]))
    axarr[1, i].xaxis.set_major_formatter(xFmt)
plt.show()
```

We use a 2-dimensional median filter to estimate the spatially and temporally autocorrelated error terms and subtract that from the raw radial wind speed values, leaving us with an estimate of the residual error. The residuals can then be modeled as a Gaussian variance-switching process without autocorrelated errors, which allows us to solve the model with existing methods.


```{python, fig.cap='RWS data and results', fig.align='center', fig.width=3.17, fig.env="figure*"}
# add the current folder to the import path
import sys
sys.path.append('.')

# import modules
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
import math, warnings
import numpy as np
warnings.simplefilter("ignore")
import xarray as xr
import rasppy
from scipy.ndimage import median_filter
from mrf import estimate_status
from pandas.tseries import converter as pdtc
pdtc.register()

# read data
lidar = xr.open_dataset('cestm_roof80_20171003.nc')

# get estimated status
lidar['status2'] = estimate_status(lidar, beta=.4)

# make figure
lidar2_0 = lidar.rasp.los_format().sel(LOS=0)
lidar2_0.swap_dims({'scan': 'Time'})
lidar2_0['filtered_RWS'] = (lidar2_0['RWS'].dims, median_filter(lidar2_0['RWS'], size=(7, 59)))
a1 = xr.concat([lidar2_0['RWS'],
                lidar2_0['RWS'].where(lidar2_0['Status']),
                lidar2_0['filtered_RWS'],
                lidar2_0['RWS'].where(lidar2_0['status2'] > .5)], dim='Data')
a1.coords['Data'] = ['Unfiltered RWS', 'CNR Threshold Wind', 'Median', 'HMRF Wind']
# rename some of the coordinates to make better graph labels
a1 = a1.rename({'Time': 'Hour [UTC]', 'Range': 'Range [m]'})
a1 = a1.rename('RWS [m/s]')
a1.plot(x='Hour [UTC]', y='Range [m]', col='Data', col_wrap=2, robust=True, center=0, vmin=-5, cmap='coolwarm', rasterized=True)
# clean up the axes
axes = plt.gcf().axes
xFmt = mdates.DateFormatter('%H')
for i in range(len(axes) - 1):
    axes[i].xaxis.set_major_locator(mdates.AutoDateLocator(minticks=4, maxticks=5))
    axes[i].xaxis.set_major_formatter(xFmt)
plt.show()
```


# Validation

testing against co-located NWS radiosonde data


# Application to lake wind effect

something about lakes and winds


# AMS formatting notes

## Secondary headings {-}

Secondary headings labeled with letters are formatted using the `## Secondary headings {-}` for a single subsection within a section or `## Secondary headings` for multiple subsections within one section.

### Tertiary headings {-}

Tertiary headings are formatted using the `### Tertiary headings {-}` for single a subsubsection within a subsection or `### Tertiary headings` for multiple subsubsections within a subsection. 

\paragraph*{Quaternary headings}
Quaternary headings are formatted using the `\paragraph*{Quaternary headings}` for a single paragraph within a subsubsection or `\paragraph{Quaternary headings}` for multiple paragraphs within a subsection.

# Citations

Citations to standard references in text should consist of the name of the author and the year of publication, for example, @poe12 or [@poe12;@alexander:2002;@Gershunov2012] using the appropriate `@key` or `[@key]` commands, respectively. A variety of citation formats can be used with the natbib package; however, the AMS prefers that authors use only the `@key` and `[@key]` commands. References should be entered in the references.bib file. For a thorough discussion of how to enter references into the references.bib database file following AMS style, please refer to the **AMS_Refs.pdf** document included in this package.

# Formatting math

The following sections will outline the basic formatting rules for mathematical symbols and units.  In addition, a review of the amspaper.tex file will show how this is done with the use of \LaTeX\ commands.  The AMS template provides the American Mathematical Society math, font, symbol, and boldface packages for use in math mode.

## Mathematical symbols

Symbols must be of the same font style both in text discussion and in displayed equations or terms (and figures should be prepared to match). Scalar single-character symbols are set italic, Greek, or script. Examples are $u$, $L$ [note that $\upsilon$ (Greek upsilon) is used instead of *v* (italic "vee") to avoid confusion with $\nu$ (Greek nu) often used for viscosity; this is handled automatically when in \LaTeX\ math mode], $w$, $x$, $y$, $z$, $f$, $g$, $r$, indices such as $i$ or $j$, and constants such as $C_D$, $k$, or $K$. Multiple-character scalar variables, abbreviations, nondimensional numbers, and acronyms for variables are set regular nonitalic: $\mathrm{LWC}$, $\mathrm{Re}$, $\mathrm{Ro}$, $\mathrm{BT}$, $\mathrm{abs}$, $\mathrm{obs}$, $\mathrm{max}$, $\mathrm{min}$, $\mathrm{Re}$/$\mathrm{Im}$ (real/imaginary), etc. For vectors, use boldface nonitalic Times Roman as in $\mathbf{V}$, $\mathbf{v}$, or $\mathbf{x}$, and $\mathbf{i}$, $\mathbf{j}$, and $\mathbf{k}$ unit vectors. Do not use the \LaTeX\ $\backslash vec$ command to denote vectors. For matrix notation, use nonitalic boldface Arial (or sans serif) font as in $\pmb{\mathsf{A}}$, $\pmb{\mathsf{B}}$, or $\pmb{\mathsf{M}}$. Note that you will need to use the $\backslash$pmb command for boldface sans serif; the $\backslash$bm command will not work. All mathematical operator abbreviations/acronyms are set lowercase regular Roman font, except $O$ (on the order of): $\sin$, $\cos$, $\tan$, $\tanh$, $\mathrm{cov}$, $\Pr$ (for probability; note same as Prandtl number), $\mathrm{const}$ (for constant), $\mathrm{c.c.}$ (complex conjugate).

## Units

Units are always set on a single line with a space separating the denominator, which is set with a superscript $-1$, $-2$, and so on, rather than using a slash for "per." Examples are g kg$^{-1}$, m$^2$ s$^{-1}$, Wm$^{-2}$, g m$^{-3}$, and m s$^{-1}$ (note that ms$^{-1}$ is the unit for "per millisecond").

## Equations

Brief equations or terms set inline in text must be set as a single-line expression because page proofs are not double spaced, for example, $\rho^{-1}p/x$ or $(1/{\rho})p/x$ or $(a-b)/(c+d)$; that is, use a superscript $-1$ for the denominator. In case of a more complicated term or equation, it should be set as an unnumbered display equation, such as

$$
x=\frac{2b\pm\sqrt{b^{2}-4ac}}{2c}.
$$

Otherwise, numbered display equations can be entered using the appropriate equation command, such as 

\begin{equation}
x=\frac{2b\pm\sqrt{b^{2}-4ac}}{2c}.  
\end{equation}

Lists of equations are punctuated as written English, and commas, semicolons, and periods are placed where appropriate. Conjunctions such as "and", "while", "when", or "for" are also typically placed before the final element in a mathematical phrase, as befits the intended mathematical meaning.  

## Figures and tables

The AMS prefers that all figures and tables are placed **at the end of the document** prior to submission. A list of tables and a list of figures will appear near the end of the PDFfile, before the actual tables and figures. These lists are necessary for submission.

For appendix figures and tables, special commands are needed to manually change the numbering to ensure that each appendix figure or table is numbered as part of the respective appendix and not as a continuation of the main paper. Use the command `\appendcaption{}` instead of the usual `caption{}` to adjust the  numbering; for example, for Table A1, you would use the command `\appendcaption{A1}`.

Note that the normal `\ref{}` command cannot be used to cite appendix figures and tables as the numbering will be incorrect. Callouts for appendix figures and tables in the text will need to be written out as plain text, for example, Fig. A1 and Table A1.

### Figures

The insertion of a sample figure (Fig. \ref{f1})  
and caption is given below (in the .tex document) and at the end of the document. Standard figure sizes are 19 (one column), 27, 33, and 39 (two columns) picas.

<!-- \begin{figure}[h] -->
<!--  \centerline{\includegraphics[width=19pc]{figure01.pdf}} -->
<!--   \caption{Enter the caption for your figure here.  Repeat as -->
<!--   necessary for each of your figures.}\label{f1} -->
<!-- \end{figure} -->

```{r,echo=FALSE,fig.cap='test the rmd output',fig.align='center',fig.width=3.17}
plot(1:10)
```

### Tables
Each table must be numbered, provided with a caption, and mentioned specifically in the text. 
See below (in the .tex document) and at the end of the document for the formatting of a sample table (Table
\ref{t1}).

\begin{table}[h]
\caption{This is a sample table caption and table layout.}\label{t1}
\begin{center}
\begin{tabular}{ccccrrcrc}
\topline
$N$ & $X$ & $Y$ & $Z$\\
\midline
 0000 & 0000 & 0010 & 0000 \\
 0005 & 0004 & 0012 & 0000 \\
 0010 & 0009 & 0020 & 0000 \\
 0015 & 0016 & 0036 & 0002 \\
 0020 & 0030 & 0066 & 0007 \\
 0025 & 0054 & 0115 & 0024 \\
\botline
\end{tabular}
\end{center}
\end{table}

\acknowledgments
Keep acknowledgments (note correct spelling: no e between the g and m) as brief as possible. In general, acknowledge only direct help in writing or research. Financial support (e.g., grant numbers) for the work done, for an author, or for the laboratory where the work was performed is best acknowledged here rather than as footnotes to the title or to an author's name. Contribution numbers (if the work has been published by the author's institution or organization) should be included as footnotes on the title page,
not in the acknowledgments.

Please use The authors thank \ldots rather than The authors would like to thank \ldots.

The author thanks Mats Dahlgren for version one of \textsf{achemso}, and Donald Arseneau for the code taken from \textsf{cite} to move citations after punctuation. Many users have provided feedback on the class, which is reflected in all of the different demonstrations shown in this document.

\appendix[A] 

\appendixtitle{Title of Appendix}

## Appendix section

The AMS template allows authors to format an unlimited number of appendixes. To format a single appendix, use the `\appendix` command with no additional argument. Otherwise, add the appropriate one-letter argument to the `\appendix` command (e.g. `\appendix[A]`, `\appendix[B]`, `\appendix[C]`, etc.) corresponding to the appropriate appendix. 

The title of the appendix can be formatted using the `\appendixtitle{} ` command. The `##` , `###` and `\paragraph` commands are used to create sections within the appendix. (Note that the appendix title takes the place of `#` in the appendix, so the first section should begin with `##` instead of `#`.)

Equations are automatically numbered appropriately for each appendix. Here is an example of the first equation in appendix A, automatically labeled (\ref{eq:1}): 

\begin{equation}
\label{eq:1}
x=\frac{2b\pm\sqrt{b^{2}-4ac}}{2c}.  
\end{equation}

For appendix figures and tables, special commands are needed to manually change the numbering to ensure that each appendix figure or table is numbered as part of the appendix and not as a continuation of the main paper. Use the command `\appendcaption{}` instead of the usual `\caption{}` to adjust the numbering; for example, for Table A1, you would use the command `\appendcaption{A1}`. In-text callouts for each appendix figure and table will need to be written as plain text;the usual `\ref{}` command cannot be used.

\appendix[B]
\appendixtitle{File Structure of the AMS \LaTeX\ Package}

## AMS \LaTeX\ files
You will be provided with a tarred, zipped \LaTeX\ package containing 3 files. These files are

\begin{description}

\item
  your-paper-name.Rmd template for your paper
\item
  amstest.bib an example of a bibliographic database file.
\item
  figure01.pdf are sample figures.

\end{description}

## Help for Authors

Questions and feedback concerning the use of the AMS \LaTeX\ files should be directed to latex@ametsoc.org or yufreecas@gmail.com(for rmarkdown issues). Additional information is available on the AMS \LaTeX\ Submission Info web page (\url{http://www2.ametsoc.org/ams/index.cfm/publications/authors/journal-and-bams-authors/author-resources/latex-author-info/}).

\appendix[C]
\appendixtitle{Building a PDF and Submitting Your \LaTeX\ Manuscript Files to the AMS}

## Building your own PDF

There are a variety of different methods and programs that will create a final PDF from your \LaTeX\ files. The easiest method is to download one of the freely available text editors/compilers such as Rstudio to compile your files into a PDF.

## Submitting your files to the AMS for peer review

The AMS uses the Editorial Manager system for all author submissions for peer review. Editorial Manager uses the freely available \TeX\ Live 2011 distribution. This system will automatically generate a PDF from your submitted \LaTeX\ files and figures(not Rmd file, tex files will be produced when you successful knit your Rmd file).  

You should not upload your own PDF into the system. If the system does not build the PDF from your files correctly, refer to the AMS \LaTeX\ FAQ page first for possible solutions. If your PDF still does not build correctly after trying the solutions on the FAQ page, email latex@ametsoc.org for help.

## Other software
As mentioned above, there is a variety of software that can be used to edit .tex files and build a PDF.  The AMS does not support \LaTeX\/-related WYSIWYG software, such as Scientific Workplace, or WYSIWYM software, such as LyX.  \TeX\ Live (available online at \\ \url{http://www.tug.org/texlive/}) is recommended for users needing an up-to-date \LaTeX\ distribution with software that includes an editor and the ability to automatically generate a PDF.

# References {-}
\bibliography{references}

\begin{table}
\appendcaption{A1}{Here is the appendix table caption.}
\centering
\begin{tabular}{ccc}
\topline
$1$ & $2$ & $3$ \\
\midline
a&b&c \\
d&e&f \\
\botline
\end{tabular}
\end{table}

\begin{figure}
\centerline{(illustration here)}
\appendcaption{A1}{Here is the appendix figure caption.}
\end{figure}

\begin{figure}
\centerline{(illustration here)}
\appendcaption{B1}{Here is the appendix figure caption.}
\end{figure}
